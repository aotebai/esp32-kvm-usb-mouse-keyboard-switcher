# ESP32-S3 KVM 切换器（双设备键鼠共享）

## 🌐 语言切换
- [📝 中文版本 (当前)](./docs/README_zh.md)
- [🔤 English Version](../README.md)

---

## 📝  中文版本

### 项目介绍
一款基于 ESP32-S3 和 CH9350 模块的双设备 KVM 切换器，可实现一套键鼠无缝共享给两台电脑，搭配ESP32S3板载RGB-LED 灯光特效指示工作状态，无需安装驱动，无开发经验用户也可通过预编译固件一键烧录使用。支持双设备供电冗余设计，确保单设备开机时系统仍能稳定运行。

### ✨ 核心功能
- 双设备切换：支持 2 台电脑之间的键鼠快速切换（共享一套键盘和鼠标）
- 两种切换方式：鼠标中键（可通过三位微动开关的K2键禁用）或三位微动开关 K1 键
- 灯光特效指示：切换时 LED 三种不重复的颜色顺序爆闪、 蓝色呼吸灯特效指示上位机 A，红色呼吸灯特效指示上位机 B，无频闪、无熄灭异常
- 核心功能完整：键鼠 DMA 透传，鼠标中键切换，三位微动开关 K1 键切换，K2键（开/关）鼠标中间键功能，K3键短按控制 LED、长按复位，静置后无功能衰减
- 供电冗余设计：通过肖特基二极管实现双设备供电互备，单设备开机即可保障系统正常运行
- 开发环境兼容：兼容 ESP-IDF v5.5.1，无第三方依赖，仅使用原生兼容 API，运行稳定
- 免驱兼容：支持所有支持 USB HID 协议的操作系统（Windows/Mac/Linux）
- 一键烧录：提供预编译固件，无需搭建 ESP-IDF 开发环境

### 🛠️ 硬件清单
| 硬件名称 | 购买链接 | 数量 | 单价(元) | 金额(元) | 快递费(元) | 合计(元) |
|----------|----------|------|----------|----------|------------|----------|
| ESP32 S3 核心板（1-N16R8） | [ESP32 S3 核心板](https://item.taobao.com/item.htm?id=715306783664) |     1 | 24.1 | 24.1 | 0 | 24.1 |
| CH9350 模块 | [CH9350 模块](https://item.taobao.com/item.htm?id=695173316772) |     3 | 18.5 | 55.5 | 3 | 58.5 |
| 三位微动开关（含 K1/K2/K3 按键） | [三位微动开关](https://item.taobao.com/item.htm?id=550176517768) |     1 | 3.88 | 3.88 | 0 | 3.88 |
| USB OTG 线 (公对公) | [USB OTG 线](https://item.taobao.com/item.htm?id=550176517768) |     6 | 0.85 | 5.1 | 2 | 7.1 |
| 直插肖特基二极管DO-41(1N5819 1A 40V) | [直插肖特基二极管](https://detail.tmall.com/item.htm?id=781535844592) | 20(使用2个) | 1.7 | 1.7 | 0 | 1.7 |
| 304不锈钢十圆头螺丝螺母套装 (M2.5x8)| [圆头螺丝螺母套装](https://detail.tmall.com/item.htm?id=637072501037) | 50(使用14个) | 4.7 | 4.7 | 0 | 4.7 |
| 3D打印外壳 | [3D打印](https://www.jlc-3dp.cn/fp/Amntaau/1) |     1 | 24.78 | 24.78 | 3.2 | 27.98 |

### 🔌 接线与组装
1. 将键盘、鼠标分别连接至 CH9350 模块的对应 USB 接口
2. CH9350模块 UART口(上位机A) 与 ESP32-S3 连接：TXD→U0RX (GPIO10)、RXD→U0TX (GPIO11) 、GND→GND、5V→1N5819→5V（确保供电稳定）
3. CH9350模块 UART口(上位机B) 与 ESP32-S3 连接：TXD→U2RX (GPIO44)、RXD→U2TX (GPIO43) 、GND→GND、5V→1N5819→5V（确保供电稳定）
4. 三位微动开关接线：K1/K2/K3 按键分别连接至 ESP32-S3 对应的 GPIO 引脚
5. 肖特基二极管:两个二极管正极分别接上位机A、上位机B的5V引脚，负极接ESP32S3的5Vin和下位机C的5V引脚(确保在一台计算机开机的情况下有效供电，整个系统能正常运行)
6. 将所有部件整理后，组装至 3D 打印外壳中，固定牢固避免接触不良

#### 接线示意图
##### 1. 电源部分接线



       [上位机 A]                       [上位机 B]
          |                               |
        5V_OUT                           5V_OUT
          |                               |
          +-----> [D1] +-----+            +-----> [D2] +-----+
          |       (1N5819)   |            |       (1N5819)   |
          |       DO-41      |            |       DO-41      |
          |                  |            |                  |
          +------------------+------------+------------------+
                             |
                        [系统 5V 总线]
                             |
                  +----------+-----------+
                  |                      |
            [ESP32S3]                [下位机 C]
            5V (Vin)                 5V_IN
            GND -------------------- GND

    两个二极管正极分别接上位机 A、上位机 B 的 5V 引脚，负极汇接到系统 5V 总线
    系统 5V 总线为 ESP32S3 和下位机 C 供电，确保单台计算机开机时系统仍能正常运行

##### 2. 串口与控制部分接线


       [ESP32S3]                  [上位机 A]
       U0TX (GPIO11) ------------> RXD
       U0RX (GPIO10) <------------ TXD
       
       [ESP32S3]                  [上位机 B]
       U2TX (GPIO43) ------------> RXD  
       U2RX (GPIO44) <------------ TXD
       
       [ESP32S3]                   [下位机 C]  
       U1TX (GPIO17) ------------> TXD 
       U1RX (GPIO18) <------------ RXD
       
       
       [ESP32S3]                   [微动开关]
       GPIO12 -------------------->(K1) 
       GPIO13 -------------------->(K2) 
       GPIO14 -------------------->(K3) 
       




### 🚀 一键烧录（无需 ESP-IDF）
#### 适用于 Windows 用户
1. 下载 [乐鑫 ESP Flash Download Tool](https://docs.espressif.com/projects/esp-test-tools/zh_CN/latest/esp32/production_stage/tools/flash_download_tool.html)（选择对应系统版本，建议下载最新版）
2. 将 ESP32-S3 开发板通过 USB 线连接电脑，选择对应的 COM 口（未识别请安装 ESP32-S3 专用 USB 驱动）
3. 设置烧录参数：`80MHz` / `DIO` / `2MB`（严格对应固件配置，避免烧录失败）
4. 添加固件文件并对应烧录地址：
    - `bootloader.bin` @ `0x0`
    - `partition-table.bin` @ `0x8000`
    - `ch9350_led_switch.bin` @ `0x10000`
5. 点击工具界面「START」按钮开始烧录，等待进度条完成（提示“FINISH”即为成功）

详细地址说明及参数核对：`firmware/precompiled/flash_addresses.md`

### 🎮 使用方法
1. 通过 USB 线将 ESP32-S3 分别连接至两台目标电脑，确保电脑正常识别设备（无驱动提示即可）
2. 设备切换：按下「鼠标中键」或「三位微动开关 K1 键」，LED 三种颜色顺序爆闪，完成后对应上位机呼吸灯亮起（蓝色为上位机 A，红色为上位机 B）
3. 鼠标中键功能控制：按下「K2 键」可切换鼠标中键切换功能的开启/关闭（建议搭配 LED 指示灯区分开关状态）
4. LED 控制与复位：短按「K3 键」可手动控制 LED 灯光开关；长按「K3 键」3 秒以上，设备复位至初始状态

### 🎨 3D 外壳与 CAD 图纸
- 3D 模型：`3d_models/`（含 FreeCAD 源文件及 STL 打印文件，可直接用于 3D 打印）
- 2D 平面图：`cad_drawing/`（DWG + DXF 格式，可用于加工或修改尺寸）

3D 外壳渲染图：
![3D 外壳渲染图](docs/screenshots/case_render.jpg)

### 🔨 从源码编译（开发者专用）
1. 安装 ESP-IDF v5.5.1 版本（严格对应版本，避免兼容性问题）
2. 克隆本仓库至本地：`git clone https://github.com/aotebai/esp32-kvm-usb-mouse-keyboard-switcher.git`
3. 进入项目目录，执行以下命令编译、烧录：
```bash
idf.py set-target esp32s3
idf.py build
idf.py -p /dev/ttyUSB0 flash monitor
```

### ❓ 常见问题（FAQ）
Q1：烧录失败 / 无法识别 COM 口

A：安装 ESP32-S3 对应 USB 驱动；更换优质 USB 线（避免数据线仅充电不传输数据）；更换电脑 USB 端口；确保开发板进入下载模式（按对应按键组合操作）。

Q2：组装后设备无响应、LED 不亮

A：检查接线（尤其是供电线路和 UART 串口连接，避免接反引脚）；验证固件烧录地址是否正确；确保 CH9350 模块获得稳定 5V 供电，ESP32-S3 供电电压正常；检查二极管方向是否接反。

Q3：切换功能正常，但键鼠无法被电脑识别

A：确认目标电脑将 ESP32-S3 识别为 USB HID 设备（设备管理器中可查看）；更换电脑 USB 端口或 USB 线；更新至项目最新版本固件，检查 CH9350 模块与 ESP32-S3 通信是否正常。

Q4：LED 灯光特效异常（频闪、颜色错误）

A：检查 LED 灯珠接线是否牢固、引脚对应正确；确认固件中 LED 控制逻辑与硬件接线一致；更换故障 LED 灯珠尝试。

Q5：单台电脑开机时系统无法工作

A：检查二极管接线方向是否正确（正极接上位机 5V，负极接系统总线）；确认二极管型号为 1N5819（确保正向导通压降低）；检查供电线路是否存在接触不良。

### 📺 演示视频
B 站演示链接（替换为你的实际视频链接）
### 📄 开源协议
Apache License 2.0（详见根目录 LICENSE 文件）


